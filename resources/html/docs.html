<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Help</title>
    <link rel="icon" type="image/x-icon" href="resources/psrest.ico">
    <link rel="stylesheet" href="resources/colours.css" />
    <link rel="stylesheet" href="resources/code-colours.css" />
    <link rel="stylesheet" href="resources/code.css" />
    <style>
        body{
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            margin-bottom: 0;
            background-color: var(--background);
            color: var(--text);
            line-height: 1.5;
            display: grid;
            grid-template-columns: 20% 80%;            
        }

        .content a {
            color: var(--linkColour);
            font-weight: bold;
            text-decoration: none;
        }

        .content a:hover {
            border-bottom: 3px solid var(--linkColour);
        }

        .content {
            width: 90%;
            max-width: 1000px;
        }
        
        .content h1 {
            font-size: 3em;
            text-align: center;
        }

        .content h2 {
            font-size: 2em;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .content h3 {
            font-size: 1.5em;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .content h4 {
            font-size: 1.25em;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

       
        .sidebar {
            background-color: var(--primary);
            position: relative;
        }

         /* put center the sidebar index to be in the center of the sidebar div */
        /* .sidebar .index{
            margin-top: 0;
            position: fixed;
            width: 20%;
            list-style-type: none; 
            padding: 0;
        } */

        .sidebar ul{
            list-style-type: none;  
        }
        /* style the sidebar links */
        .sidebar a {
            display: block;
            color: var(--text);
            padding: 16px;
            text-decoration: none;
            border-radius: 0.5em;
            cursor: pointer;
        }

        .sidebar a:hover {
            background-color: var(--secondary);
            color: var(--text);
        }

        /* put the main content to the right of the sidebar */
        .content {
            margin-left: 200px;
            padding: 1px 16px;
            margin: auto;
        }

        .content li {
            margin-block: 1rem;
        }

        pre code{
            border-radius: 0.25rem;
            overflow-x: scroll;
        }

        .breakLine {
            margin-block: 2rem;
            border-bottom: 0.25rem solid var(--secondary);
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <ul class="index">
            <li><a href="./">Home</a></li>
            <li><a href="#config">Configuration</a>
                <ul>
                    <li><a href="#configFile">Config File</a></li>
                    <li><a href="#help">Help</a></li>
                </ul>
            </li>
            <li><a href="#auth">Authentication</a></li>
            <li><a href="#run">Run Commands</a></li>
            <li><a href="#help">Help</a></li>
            <li><a href="#about">About</a></li>
        </ul>
    </div>
    <div class="content">
        <section class="header">
            <h1>Documentation</h1>
            <p>
                PSRest is a Powershell module that allows you to run Powershell commands via a REST API. PSRest is designed to be used as a REST API
                for Powershell, allowing you to run Powershell commands from any language or source that can make HTTP requests. PSRest is designed to be used
                as a REST API for Powershell. If you need more information about PSRest you can find it on the <a href="psrest.com">PSRest website</a>.
            </p>
        </section>






        <h2 id="config">Configuration</h2>
        <section class="configuration">
            <span>
                PSRest offers a number of configuration options to allow you to alter the behaviour of the application.
                There are two ways to configure PSRest, either by using a config file or by using the Powershell Cmdlets packaged with PSRest.
            </span>

            <h4 id="configFile">Config File</h3>
            <span>
                The config file is a JSON file that is used to configure PSRest. The config file is located in the `config` in the user application data folder
                for the user that is running PSRest. On Windows this is located at `C:\Users\&lt;username&gt;\AppData\Roaming\PSRest\config.json`.
                On MacOS the config file is located at `~/.config/PSRest/config.json`.
            </span>
            <h4 id="Port">Port</h4>
            <span>
                The port `Port` option allows you to specify the port that PSRest will listen on. 
            </span>
            <h4 id="Cert">Certificate</h4>
            <span>
                The `certificate` option allows you to specify the filepath of the certificate that PSRest will use to encrypt the connection between the client
                and the server. This will allows you to use HTTPS to connect to PSRest. If you do not specify a certificate then PSRest will fall back and use HTTP.
            </span>
            <h4 id="Enabled">Enabled</h4>
            <span>
                The `Enabled` option allows you to specify a set of cmdlets that you want to expose via PSRest. In the config file this is an array of strings where 
                each string is the name of a cmdlet that you want to expose. If you do not specify any cmdlets then PSRest will not expose any cmdlets so no cmdlets
                can be executed via the `&lt;psrest server&gt;/run` endpoint. 

                If the list of cmdlets you want to specify is an array only containing the string `*` then PSRest will expose all cmdlets that are available to the
                user that is running PSRest. This is useful if you want to expose all cmdlets to PSRest but do not want to have to manually specify each cmdlet.
            </span>

            <h4 id="DefaultTTL">Default TTL</h4>
            <span>
                The `DefaultTTL` option allows you to specify the default time to live for a command that is run via PSRest. This is useful if you want to limit
                the amount of time that a command can run for. If you do not specify a TTL for a command then the default TTL will be used.
            </span>
            <h4 id="MaxTTL">Max TTL</h4>
            <span>
                The `MaxTTL` option allows you to specify the maximum time to live for a command a user can specify when running a command via PSRest. This is
                useful if you want to limit the amount of time that a command can run for. 
            </span>
            <h4 id="StrictTTL">Strict TTL</h4>
            <span>
                The `StrictTTL` option allows you to specify whether or not PSRest should not allow a user to specify a TTL. If this option is enabled then
                PSRest will not allow a user to specify a TTL when running a command via PSRest and commands will only be able to run as long as defined by
                the `DefaultTTL`. If this option is disabled then PSRest will allow a user to define a TTL for their command upto the maximum TTL defined by
                the `MaxTTL` option.
            <h4 id="Help">Help</h4>
            <span>
                When the `Help` option in the config is enabled, PSRest will automatically generate a help page for all commands that can be run by PSRest.
                These help pages can be found at the following URL: ` &lt;psrest server&gt;/help/&lt;cmdlet name&gt; ` these help pages produce the same output
                as the `Get-Help` cmdlet in Powershell with the `Full` swicth enabled.

                These help pages offer a great way to document how to use commands you decide to expose via PSRest, allowing others to learn how to use your
                commands without having to read the source code or directly ask you for support.
            </span>

            <h4 id="Docs">Docs</h4>
            <span>
                When the `Docs` option in the config is enabled the documentation page will be available at the following URL: ` &lt;psrest server&gt;/docs `.
                If disabled this page will be disabled and a 403 error will be returned if you try to access it.
            </span>
            <h4 id="Depth">Default Depth</h4>
            <span>
                All cmdlet output returned by PSRest when using the `&lt;psrest server&gt;/run` endpoint are JSON responses, the `Default Depth` option allows you
                to set the default depth that PSRest will use when cmdlet output to JSON. This is useful as it stops PSRest from returning a huge JSON response when
                you only want a small amount of data. The default depth is 4, which means that only the first 4 levels of nested data in the object will be returned.

                Anything deeper than this will be replaced with a `Powershell property description` of the data to indicate that there is more data available.
                If you want to see more data you can use the `depth` in your cmdlet request to specify the depth you want.
            </span>
            <h4 id="StrictDepth">Strict Depth</h4>
            <span>
                When the `StrictDepth` option is enabled, PSRest will only return the data that is specified by the `DefaultDepth` option. If the `DefaultDepth`
                option is set to 4, then only the first 4 levels of nested data will be returned. If the `StrictDepth` option is disabled, then PSRest will return
                the default depth and if a user specifies a depth then PSRest will return the depth specified by the user.
            </span>
            <h4 id="ArbitraryCommands">Strict Depth</h4>
            <span>
                When the `ArbitraryCommands` option is enabled, PSRest will stop sanitizing cmdlets in the `&lt;psrest server&gt;/run` endpoint. This means that 
                what everr raw cmdlet you pass to PSRest will be run. This is highly dangerous and should only be enabled if you know what you are doing.

                When enabled this changes the `&lt;psrest server&gt;/run` endpoint from a predefined and and authorized cmdlet runner to an invoke-expression
                endpoint, so any cmdlet string that is valid powershell will be executed by PSRest.
            </span>
            <p>
                It is recommended that you only expose the cmdlets that you need to use via PSRest and highly recommended to not expose the following cmdlets unless
                you know what you are doing:
            </p>
            <p>
                Invoke-Expression, Invoke-Command, Invoke-Item, Invoke-History, Invoke-WebRequest, Enter-PSHostProcess  Enter-PSSession
            </p>
        </section>
        <h2 id="applicationManagement">Application Management</h2>
        <section class="applicationManagement">
            <p>
                PSRest allows you to create client applications that can be used to authenticate with PSRest. When a new client application is created a
                <code class="token">client_id</code> and <code class="token">secret</code> are generated for that client application. These credentials are then
                used to authenticate the client application and generate an <code class="token">access_token</code>. The <code class="token">access_token</code>
                is then used to authenticate with PSRest and run commands.
            </p>
            <h3>Add new application</h3>
            <p>
                some documentation
            </p>
            <h3>Set application cmdlets</h3>
            <p>
                some documentation
            </p>
        </section>

        
        
        
        
        
        
        <h2 id="authentication">Authentication</h2>
        <section class="authentication">
            <p>
                The <code class="token">/oauth</code> endpoint is used to authenticate a user and provide them an <code class="token">access_token</code> when
                the authentication attempt is successful.
            </p>
            <p>
                There are 3 ways to get an <code class="token">access_token</code>:
            </p>
            <h3 id="clientCredential">Client Credential</h3>
            <p>
                When a new client application is registered with PSRest, a <code class="token">client_id</code>
                and <code class="token">secret</code> are generated for that client application. These credentials are then used to authenticate the
                client application and generate an <code class="token">access_token</code>. To learn more about registering a client application with PSRest
                check out the <a href="#applicationManagement">application management</a> section.
            </p>
            <p>
                Below is an example of how to authenticate a client application using the <code class="token">client_credential</code> method with
                <b>Invoke-WebRequest</b> and <b>Curl</b>.
            </p>
            <h4>Headers</h4>
            <pre><code class="language-yaml">Content-Type: application/json</code></pre>
            <h4>Request Body</h4>
            <pre><code class="language-json">{
    "grant_type": "client_credentials",
    "client_id": "&lt;client_id&gt;",
    "client_secret": "&lt;client_secret&gt;"
}</code></pre>
                <h4>Example</h4>
                <pre><code class="language-powershell">$body = @{
    "grant_type" = "client_credentials";
    "client_id" = "&lt;client_id&gt;";
    "client_secret" = "&lt;client_secret&gt;";
}

Invoke-WebRequest -Uri http://&lt;psrest_server&gt;/oauth -Method POST -Body $body</code></pre>
                <pre><code class="language-shell">curl -X POST http://&lt;psrest_server&gt;/oauth \
    -H "Content-Type: application/json" \
    -d '{"grant_type":"client_credentials", "client_id":"&lt;client_id&gt;", "client_secret":"&lt;client_secret&gt;"}'</code></pre>
                <h4>Response</h4>
                <pre><code class="language-json">{
    "access_token": "&lt;access_token&gt;",
    "expires_in": 3600,
    "refresh_token": "&lt;refresh_token&gt;" 
}</code></pre>
                <p>
                    <b>Note:</b> the <code class="token">expires_in</code> property is the number of seconds that the <code class="token">access_token</code> is valid for.
                </p>
                <div class="breakLine"></div>
                <h3>Refresh Token</h3>
                <p>
                    When a user authenticates with PSRest using the <code class="token"><a href="#clientCredential">client_credential</a></code> method, a <code class="token">refresh_token</code>
                    is also generated. This <code class="token">refresh_token</code> can be used to authenticate a user and generate a new
                    <code class="token">access_token</code> when the <code class="token">access_token</code> expires. The <code class="token">refresh_token</code>
                    is valid for 14 days after it is generated.
                </p>
                <p>
                    Below is an example of how to authenticate a user using the <code class="token">refresh_token</code> method with <b>Invoke-WebRequest</b> and <b>Curl</b>.
                </p>
                <h4>Headers</h4>
                <pre><code class="language-yaml">Content-Type: application/json</code></pre>
                <h4>Request Body</h4>
                <pre><code class="language-json">{
    "grant_type": "refresh_token",
    "refresh_token": "&lt;refresh_token&gt;"
}</code></pre>
                <h4>Example</h4>
                <pre><code class="language-powershell">$body = @{
    "grant_type" = "refresh_token";
    "refresh_token" = "&lt;refresh_token&gt;";
}

Invoke-WebRequest -Uri http://&lt;psrest_server&gt;/oauth -Method POST -Body $body</code></pre>
                <pre><code class="language-shell">curl -X POST http://&lt;psrest_server&gt;/oauth \
    -H "Content-Type: application/json" \
    -d '{"grant_type":"refresh_token", "refresh_token":"&lt;refresh_token&gt;"}'</code></pre>
                <h4>Response</h4>
                <pre><code class="language-json">{
    "access_token": "&lt;access_token&gt;",
    "expires_in": 3600,
    "refresh_token": "&lt;refresh_token&gt;"
}</code></pre>
                <p>
                    <b>Note:</b> the <code class="token">expires_in</code> property is the number of seconds that the <code class="token">access_token</code> is valid for.
                </p>
                <div class="breakLine"></div>
                <h3>PSRest Console</h3>
                <p>
                    When creating a new client application for PSRest you can specify if you want to generate a <code class="token">client_id</code> and
                    <code class="token">secret</code> or if you want to generate an <code class="token">access_token</code> for the
                    client application. If you choose to generate an <code class="token">access_token</code> the console will generate an access token for you
                    and display it in the console. This access token can then be used to authenticate with PSRest for 1 year.
                </p>
                <p>
                    For security reasons the 1 year <code class="token">access_token</code> method is ill-advised and you should use the
                    <code class="token"><a href="#clientCredential">client_credential</a></code> method.
                </p>
                <p>
                    Check out the <a href="#applicationManagement">application management</a> section to learn more about creating a new client application for PSRest.
                </p>
        </section>
        <h2 id="run">Run Commands</h2>
        <section class="run">
            <p>
                The <code class="token">/run</code> endpoint is the main endpoint for PSRest. This endpoint allows you to run Powershell commands via a HTTP post
                request. What commands you can run is limited to those authorised for your <code class="token">access_token</code>. Check out the
                <a href="#authentication">authentication</a> section to learn how to get an <code class="token">access_token</code> and
                <a href="#applicationManagement">application management</a> to learn how to authorize a set of cmdlets for a given application. 
            </p>
            <h3>Headers</h3>
            <p>
                Listed below are the headers that are used by the <code class="token">/run</code> endpoint.
            </p>
            <pre><code class="language-yaml">Authorization: Bearer &lt;access_token&gt;
Content-Type: application/json
Depth: &lt;int&gt;
TTL: &lt;int&gt;</code></pre>
            <ul>
                <li>
                    <code class="token"><b>Authorization</b></code> - This is a mandatory header. It should consist of the string <code class="token string">"Bearer "</code>
                    followed by the <code class="token">access_token</code> string.
                </li>
                <li>
                    <code class="token"><b>Content-Type</b></code> - This is a mandatory header and should always be set to <code class="token string">"application/json"</code>
                    when making requests to the <code class="token">/run</code> endpoint, the endpoint only supports JSON requests.
                </li>
                <li>
                    <code class="token"><b>Depth</b></code> - This is used to tell PSRest how deep to go when converting the output of a cmdlet to JSON. This
                    header is optional and if not set it will default to the value of the <code class="token"><a href="#configDefaultDepth">DefaultDepth</a></code>
                    option in the <a href="#config">config</a>. The value of this header must be a whole number between 0 and the value of the
                    <code class="token"><a href="#configMaxDepth">MaxDepth</a></code> option in the Config.
                </li> 
                <li>
                    <code class="token"><b>TTL</b></code> - This is used to tell PSRest how long to allow a command to run for before timing out. This header
                    is optional and if not set will default to the value of the <code class="token"><a href="#configDefaultTTL">DefaultTTL</a></code></a>
                    option in the config file. If the <code class="token"><a href="#configStrictTTL">StrictTTL</a></code> option is enabled in
                    the config file then this header will be ignored and the <code class="token"><a href="#configDefaultTTL">DefaultTTL</a></code>
                    option will be used.
                </li>
            </ul>
            <h3>Request Body</h3>
            <p>
                The request body sent must be a valid JSON object, here is an example that uses named parameters:
            </p>
            <pre><code class="language-json">{
    "cmdlet": "&lt;Verb-Noun&gt;",
    "parameters": {
        "&lt;param1&gt;": "value",
        "&lt;param2&gt;": 1,
        "&lt;param3&gt;": [],
        "&lt;param4&gt;": {},
        "&lt;param5&gt;": null,
        "&lt;param6&gt;": true,
        ...
    },
    "array_wrap" : true;
}</code></pre>
            <ul>
                <li>
                    <code class="token"><b>cmdlet</b></code> - This is a mandatory property on the JSON object. The value of this property must be a string and
                    should be the name of the cmdlet you want to run or the name of an installed powershell script. Using the filepath of a powershell script
                    will not work.
                </li>
                <li>
                    <p>
                        <code class="token"><b>parameters</b></code> - This is an optional property on the JSON object. The value of this property must be a
                        JSON object or array.
                    </p>
                    <p>
                        If the value of this property is an object, the properties of the object must be the name of the parameters you want to pass to the cmdlet
                        and the value of the property must be the value you want to pass to the cmdlet. The value of the property can be any valid JSON data type.
                    </p>
                    <p>
                        If the value of this property is an array, the values of the array are passed as positional parameters to the cmdlet in the order they
                        appear in the array. The values of the array can be any valid JSON data type. An example is shown below:
                    </p>
                    <pre><code class="language-json">{
    "cmdlet": "&lt;Verb-Noun&gt;", 
    "parameters": [
        "value",
        1,
        [],
        {},
        null,
        true
        ...
    ],
}</code></pre>
                    <p>
                        If the cmdlet you are running does not require any parameters then you do not need to specify this property. You can also specify this
                        property as an empty object or array if you want to be explicit that you are not passing any parameters to the cmdlet. An example is
                        shown below:
                    </p>
                    <pre><code class="language-json">{
    "cmdlet": "&lt;Verb-Noun&gt;",
}</code></pre>
                    <p>
                        <b>NOTE:</b> If the value of a given parameter is an object it will be passed as a <code class="token">PSCustomObject</code> to that parameter.
                        A <code class="token">String</code> value is also passed as literal string to the cmdlet so you can't use a variable or expression
                        as a parameter value. 
                    </p>
                <li>
                    <p>
                        <code class="token"><b>array_wrap</b></code> - This is an optional property on the JSON object. The value of this property must be a boolean
                        value if the property is not set PSRest will use <code class="token">false</code> when processing the request.
                    </p>
                    <p>
                        When set to <code class="token">true</code> the value of the <code class="token">data</code> property in the JSON response will always be
                        an array. For cmdlets that return a single non array value the result is wrapped in an array. For cmdlets that already return an array
                        the result is not wrapped. 
                    </p>
                    <p>
                        When set to <code class="token">false</code> the value of the <code class="token">data</code> property in the JSON response can be any
                        valid JSON data type. 
                    </p>
                </li>
            </ul>
            <h3>Examples</h3>
            <p>
                Below are some examples of how to use the <code class="token">/run</code> endpoint using both <b>Invoke-WebRequest</b> and <b>Curl</b>.
            <b><p>Example 1</p></b>
            <pre><code class="language-powershell">$headers = @{"Authorization": "Bearer &lt;access_token&gt;"}
$body = @{
    "cmdlet" = "Get-Date";
} | ConvertTo-Json

Invoke-WebRequest -Uri http://&lt;psrest_server&gt;/run -Method POST -Body $body -ContentType "application/json" -Headers $headers</code></pre>
            <pre><code class="language-shell">curl -X POST  http://&lt;psrest_server&gt;/run \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer <access_token>" \
    -d '{"command":"Get-Date"}'</code></pre>
            <b><p>Response</p></b>
            <pre><code class="language-json">{
    "data": {
        "value":  "\/Date(1703366724837)\/",
        "DisplayHint":  2,
        "DateTime":  "23 December 2023 21:25:24"
    }
    "error": null,
}</code></pre>
            <div class="breakLine"></div>
            <b><p>Example 2</p></b>
            <pre><code class="language-powershell">$headers = @{"Authorization": "Bearer &lt;access_token&gt;"}
$body = @{
    "cmdlet" = "Get-Date";
    "parameters" = @{
        "Date" = "01/01/2024"
    }
} | ConvertTo-Json

Invoke-WebRequest -Uri http://&lt;psrest_server&gt;/run -Method POST -Body $body -ContentType "application/json" -Headers $headers</code></pre>
            <pre><code class="language-shell">curl -X POST  http://&lt;psrest_server&gt;/run \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer <access_token>" \
    -d '{"command":"Get-Date", "parameters": {"Date": "01/01/2024"}}'</code></pre>
            <b><p>Response</p></b>
            <pre><code class="language-json">{
    "data": {
        "value":  "\/Date(1704067200000)\/",
        "DisplayHint":  2,
        "DateTime":  "01 January 2024 00:00:00"
    }
    "error": null,
}</code></pre>
            <div class="breakLine"></div>
            <b><p>Example 3</p></b>
            <pre><code class="language-powershell">$headers = @{"Authorization": "Bearer &lt;access_token&gt;"}
$body = @{
    "cmdlet" = "Get-UpTime";
    "parameters" = ["01/12/2024"];
    "array_wrap" = true;
} | ConvertTo-Json

Invoke-WebRequest -Uri http://&lt;psrest_server&gt;/run -Method POST -Body $body -ContentType "application/json" -Headers $headers</code></pre>
            <pre><code class="language-shell">curl -X POST http://&lt;psrest_server&gt;/run \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer &lt;access_token&gt;" \
    -d '{"command":"Get-Date", "parameters": ["01/12/2024"]}'</code></pre>
            <b><p>Response</p></b>
            <pre><code class="language-json">{
    "data": [
        {
            "value":  "\/Date(1733011200000)\/",
            "DisplayHint":  2,
            "DateTime":  "01 December 2024 00:00:00"
        }
    ]
    "error": null,
}</code></pre>
        </section>




        
        <h2 id="about">About</h2>
        <section class="about">
            <p>
                PSRest is an application that allows you to run Powershell commands via a REST API. Allowing you to connect anything that can speak HTTP to Powershell.
                CHeck out my soundcloud for more information about PSRest.

                Also follow me on mastodon and twitter for updates about PSRest.

                Donate to my patreon to support the development of PSRest.

                email me at leenton@psrest.com if you have any questions or want to get in touch.
            </p>
        </section>
    </div>
</body>
<script src="resources/highlight.js"></script>
<script src="resources/powershell.js"></script>
<script src="resources/json.js"></script>
<script>
  hljs.highlightAll();
</script>
</html>